Node.prototype.addEventListeners=function(e,t){for(let r of e.split(" "))this.addEventListener(r,t)};const imgData=new FormData,forms=document.querySelectorAll('form.needs-validation:not([name="bug-report"])'),localStorage=window.localStorage,sortTableFunction=e=>function(t){"a"==t.target.tagName.toLowerCase()&&(sortRows(e,siblingIndex(t.target.parentNode)),t.preventDefault())},siblingIndex=e=>{let t=0;for(;e=e.previousElementSibling;)t++;return t},sortRows=(e,t)=>{let r,a,l,n=e.querySelectorAll("tbody tr"),o="thead th:nth-child("+(t+1)+")",c="td:nth-child("+(t+1)+")",s=e.querySelector(o).classList,d=[],u="",m=!0;for(s&&(s.contains("date")?u="date":s.contains("number")&&(u="number")),a=0;a<n.length;a++)l=n[a].querySelector(c),r=l.innerText,isNaN(r)?m=!1:r=parseFloat(r),d.push({value:r,row:n[a]});""==u&&m&&(u="number"),"number"==u?(d.sort(sortNumberVal),d=d.reverse()):"date"==u?d.sort(sortDateVal):d.sort(sortTextVal);for(let t=0;t<d.length;t++)e.querySelector("tbody").appendChild(d[t].row)},sortNumberVal=(e,t)=>sortNumber(e.value,t.value),sortNumber=(e,t)=>e-t,sortDateVal=(e,t)=>{let r=Date.parse(e.value),a=Date.parse(t.value);return sortNumber(r,a)},sortTextVal=(e,t)=>{let r=(e.value+"").toUpperCase(),a=(t.value+"").toUpperCase();return r<a?-1:r>a?1:0},serializeArray=e=>Array.from(new FormData(e).entries()).reduce((function(e,t){return e[t[0]]=t[1],e}),{}),checkFirstStep=e=>!("signalement-step-1"===e.id&&null===e.querySelector('[type="radio"]:checked')||"signalement-step-1"===e.id&&e.querySelectorAll('[type="checkbox"]:checked').length!==e.querySelectorAll('[type="radio"]:checked').length),checkFieldset=e=>{let t=e.querySelector('fieldset[aria-required="true"]');return!t||(null===t.querySelector('[type="checkbox"]:checked')?(t.classList.add("fr-fieldset--error"),t?.querySelector(".fr-error-text")?.classList.remove("fr-hidden"),invalid=t.parentElement,!1):(t.classList.remove("fr-fieldset--error"),t?.querySelector(".fr-error-text")?.classList.add("fr-hidden"),!0))},goToStep=e=>{document.querySelector("#signalement-step-"+e).click()},resizeImage=function(e,t){return new Promise((function(r,a){const l=new FileReader;l.readAsDataURL(e),l.addEventListener("load",(function(e){const a=new Image;a.addEventListener("load",(function(){const e=document.createElement("canvas"),l=e.getContext("2d"),n=a.width*t,o=a.height*t;e.width=n,e.height=o,l.drawImage(a,0,0,n,o),"toBlob"in e?e.toBlob((function(e){r(e)})):r(dataUrlToBlob(e.toDataURL()))})),a.src=e.target.result})),l.addEventListener("error",(function(){a()}))}))},dataUrlToBlob=function(e){const t=e.split(","),r=t[0].match(/:(.*?);/)[1],a=atob(t[1]);let l=a.length;const n=new Uint8Array(l);for(;l--;)n[l]=a.charCodeAt(l);return new Blob([n],{type:r})};let invalid,table,thead,headers,i,j,tables=document.querySelectorAll("table.sortable");for(i=0;i<tables.length;i++)if(table=tables[i],thead=table.querySelector("thead")){for(headers=thead.querySelectorAll("th"),j=0;j<headers.length;j++)headers[j].innerHTML="<a href='#'>"+headers[j].innerText+"</a>";thead.addEventListener("click",sortTableFunction(table))}document?.querySelectorAll(".fr-pagination__link:not([aria-current])").forEach((e=>{let t,r,a,l=document.querySelector(".fr-pagination__link--prev"),n=document.querySelector(".fr-pagination__link--next"),o=document.querySelector(".fr-pagination__link--first"),c=document.querySelector(".fr-pagination__link--last"),s=1,d=parseInt(c.getAttribute("data-page"));e.addEventListener("click",(e=>{let u=new FormData;u.append("pagination","true"),u.append("search",document.querySelector("#header-search-input").value),u.append("status",document.querySelector("#filter_statut").value),u.append("ville",document.querySelector("#filter_ville").value);let m=document?.querySelector(".fr-pagination__link[aria-current]"),f=e.target;f!==l&&f!==n&&f!==o&&f!==c?s=parseInt(f.getAttribute("data-page")):f===n?s=parseInt(m.getAttribute("data-page"))+1:f===l?s=parseInt(m.getAttribute("data-page"))-1:f===c?s=parseInt(d):f===o&&(s=parseInt(1)),u.append("page",s),t=document.querySelector('.fr-pagination__link[data-page="'+s+'"]'),fetch("#",{method:"POST",body:u}).then((e=>e.text().then((e=>{let u=document.querySelector("#signalements-result");u.innerHTML=e,u.querySelectorAll("tr").forEach((e=>{gauge=new Gauge(e.querySelector(".gauge-signalement")).setOptions(opts),gauge.set(e.getAttribute("data-score"))})),m.ariaCurrent=null,m.href="#",t.removeAttribute("href"),t.ariaCurrent="page",1!==s&&s!==d?r=[o,l,n,c]:1===s?(r=[n,c],a=[o,l]):s===d&&(r=[o,l],a=[n,c]),r.forEach((e=>{e.removeAttribute("aria-disabled"),e.href="#"})),a&&a.forEach((e=>{e.removeAttribute("href"),e.ariaDisabled="true"}))}))))}))})),forms.forEach((e=>{e?.querySelectorAll('.toggle-criticite input[type="radio"]')?.forEach((e=>{e.addEventListener("change",(e=>{e.currentTarget.parentElement.parentElement.parentElement.querySelector(".fr-toggle__input").checked=!0}))})),e?.querySelectorAll(".fr-toggle")?.forEach((e=>{e.addEventListener("change",(e=>{e.target.checked||e.currentTarget.nextElementSibling.querySelectorAll('.fr-collapse input[type="radio"]').forEach((e=>{e.checked=!1,e.required=!1}))}))})),e?.querySelectorAll(".fr-accordion__title")?.forEach((e=>{e.addEventListeners("click touchdown",(e=>{e.target.parentElement.parentElement.querySelectorAll('[type="radio"],[type="checkbox"]').forEach((e=>{e.checked=!1}))}))})),e?.querySelectorAll("[data-fr-toggle-show],[data-fr-toggle-hide]")?.forEach((t=>{t.addEventListener("change",(t=>{let r=t.target.getAttribute("data-fr-toggle-show"),a=t.target.getAttribute("data-fr-toggle-hide"),l=t.target.getAttribute("data-fr-toggle-unrequire"),n=t.target.getAttribute("data-fr-toggle-require");r&&r.split("|").map((t=>{let r;"signalement-consentement-tiers-bloc"===t?(r=document?.querySelector("#signalement-consentement-tiers-bloc"),r.querySelector('[type="checkbox"]').required=!0):(r=e?.querySelector("#"+t),r.querySelectorAll('input:not([type="checkbox"]),textarea,select').forEach((e=>{e.required=!0}))),"signalement-methode-contact"===r.id&&r.querySelector("fieldset").setAttribute("aria-required",!0),r.classList.remove("fr-hidden")})),a&&a.split("|").map((t=>{let r;"signalement-consentement-tiers-bloc"===t?(r=document.querySelector("#signalement-consentement-tiers-bloc"),r.querySelector('[type="checkbox"]').required=!1):(r=e?.querySelector("#"+t),r?.querySelectorAll('input:not([type="checkbox"]),textarea,select')?.forEach((e=>{e.required=!1}))),"signalement-methode-contact"===r.id&&(r?.querySelector('fieldset[aria-required="true"]')?.removeAttribute("aria-required"),r?.querySelectorAll('[type="checkbox"]')?.forEach((e=>{e.checked=!1}))),r.classList.add("fr-hidden")})),l&&l.split("|").map((t=>{let r=e?.querySelector("#"+t);r.required=!1,r?.parentElement?.classList?.remove("fr-input-group--error"),r?.parentElement?.querySelector(".fr-error-text")?.classList.add("fr-hidden"),r?.classList?.remove("fr-input--error"),r.labels[0].querySelector("sup")&&(r.labels[0].querySelector("sup").innerHTML="")})),n&&n.split("|").map((t=>{let r=e?.querySelector("#"+t);r.required=!0,r?.labels[0]?.innerText.includes("*")||(r.labels[0].innerHTML=r.labels[0].innerText+'<sup class="fr-text-default--error">*</sup>')}))}))})),e?.querySelectorAll('input[type="file"]')?.forEach((e=>{e.addEventListener("change",(e=>{if(e.target.files.length>0){let a=e.target.parentElement.parentElement.querySelector(".signalement-uploadedfile-delete"),l=e.target?.parentElement?.querySelector("img"),n=!1;if(l){const a=524288,o=a/e.target.files[0].size/2;e.target.files[0].size>a?(t=e.target.files[0],r=o,new Promise((function(e,a){const l=new FileReader;l.readAsDataURL(t),l.addEventListener("load",(function(t){const a=new Image;a.addEventListener("load",(function(){const t=document.createElement("canvas"),l=t.getContext("2d"),n=a.width*r,o=a.height*r;t.width=n,t.height=o,l.drawImage(a,0,0,n,o),"toBlob"in t?t.toBlob((function(t){e(t)})):e(dataUrlToBlob(t.toDataURL()))})),a.src=t.target.result})),l.addEventListener("error",(function(){a()}))}))).then((function(t){l.src=URL.createObjectURL(t),imgData.append(e.target.name,t),e.target.value=""})):l.src=URL.createObjectURL(e.target.files[0]),["fr-fi-instagram-line","fr-py-7v"].map((t=>e.target.parentElement.classList.toggle(t))),n=!0}else e.target.parentElement.classList.contains("fr-fi-attachment-fill")&&(e.target.files[0].size>2097152?(e.target.value="",e.target.parentElement.parentElement.querySelector("small.fr-hidden").classList.remove("fr-hidden")):(n=!0,["fr-fi-attachment-fill","fr-fi-checkbox-circle-fill"].map((t=>e.target.parentElement.classList.toggle(t)))));n&&([l,a].forEach((e=>e?.classList?.remove("fr-hidden"))),a.addEventListeners("click touchdown",(t=>{t.preventDefault(),l?(l.src="#",e.target.parentElement.classList.add("fr-fi-instagram-line")):e.target.parentElement.classList.contains("fr-fi-checkbox-circle-fill")&&["fr-fi-attachment-fill","fr-fi-checkbox-circle-fill"].map((t=>e.target.parentElement.classList.toggle(t))),e.target.value="",imgData.delete(e.target.name),[l,a].forEach((e=>e?.classList.add("fr-hidden")))})))}var t,r}))})),e?.querySelectorAll("[data-fr-adresse-autocomplete]").forEach((t=>{t.addEventListener("keyup",(()=>{t.value.length>10&&fetch("https://api-adresse.data.gouv.fr/search/?q="+t.value).then((t=>{t.json().then((t=>{let r=e.querySelector("#signalement-adresse-suggestion");r.innerHTML="";for(let a of t.features){let t=document.createElement("div");t.classList.add("fr-col-12","fr-p-3v","fr-text-label--blue-france","fr-adresse-suggestion"),t.innerHTML=a.properties.label,t.addEventListener("click",(()=>{e.querySelector("#signalement-adresse-occupant").value=a.properties.name,e.querySelector("#signalement-cp-occupant").value=a.properties.postcode,e.querySelector("#signalement-ville-occupant").value=a.properties.city,e.querySelector("#signalement-insee-occupant").value=a.properties.citycode,e.querySelector("#signalement-geoloc-lat-occupant").value=a.geometry.coordinates[0],e.querySelector("#signalement-geoloc-lng-occupant").value=a.geometry.coordinates[1],r.innerHTML=""})),r.appendChild(t)}}))}))}))})),e.addEventListener("submit",(t=>{if(t.preventDefault(),e.checkValidity()&&checkFirstStep(e)&&checkFieldset(e))if(e.querySelectorAll("input,textarea,select").forEach((e=>{let t=e.parentElement;"radio"===e.type&&(t=e.parentElement.parentElement.parentElement),[e.classList,t.classList].forEach((e=>{e.remove(e[0]+"--error")})),t.querySelector(".fr-error-text")?.classList.add("fr-hidden")})),"signalement"!==e.name)e.submit();else{let e=document.querySelector('.fr-tabs__list>li>button[aria-selected="true"]').parentElement?.nextElementSibling?.querySelector("button");if(e&&(e.hasAttribute("data-fr-last-step")&&(document.querySelector("#recap-signalement-situation").innerHTML="",forms.forEach((e=>{e.querySelectorAll("input,textarea,select").forEach((e=>{document.querySelector("#recap-"+e.id)?document.querySelector("#recap-"+e.id).innerHTML=e.value:e.classList.contains("signalement-situation")&&e.checked&&(document.querySelector("#recap-signalement-situation").innerHTML+="- "+e.value+"<br>")}))}))),e.disabled=!1,e.click()),!e){t.submitter.disabled=!0,["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>t.submitter.classList.toggle(e))),t.submitter.innerHTML="En cours d'envoi...";let e=new FormData;forms.forEach((t=>{let r=serializeArray(t);for(let t=0;t<Object.keys(r).length;t++){let a=Object.keys(r)[t],l=Object.values(r)[t];imgData.has(a)?(e.append(a,imgData.get(a)),imgData.delete(a)):e.append(a,l)}})),fetch("signalement/envoi",{method:"POST",body:e}).then((e=>{e.ok?e.json().then((e=>{"success"===e.response?(document.querySelectorAll("#signalement-tabs,#signalement-success").forEach((e=>{e.classList.toggle("fr-hidden")})),localStorage.clear()):(t.submitter.disabled=!1,t.submitter.innerHTML="Confirmer",["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>t.submitter.classList.toggle(e))),alert("Erreur signalement !"))})):(t.submitter.disabled=!1,t.submitter.innerHTML="Confirmer",["fr-fi-checkbox-circle-fill","fr-fi-refresh-fill"].map((e=>t.submitter.classList.toggle(e))),alert("Erreur signalement !"))}))}}else if(t.stopPropagation(),"signalement-step-1"===e.id?(e.querySelector('[role="alert"]').classList.remove("fr-hidden"),e?.querySelectorAll(".fr-fieldset__content.fr-collapse.fr-collapse--expanded").forEach((e=>{e.querySelector('[type="radio"]:first-of-type').required=!0,e.querySelector("input:invalid")&&(e.classList.add("fr-fieldset--error"),e.querySelector(".fr-error-text").classList.remove("fr-hidden"))})),invalid=e?.querySelector("*:invalid:first-of-type")?.parentElement,invalid||(invalid=document.querySelector("div[role='alert']")),e.addEventListener("change",(()=>{e?.querySelectorAll(".fr-fieldset__content.fr-collapse.fr-collapse--expanded").forEach((e=>{null===e.querySelector("input:invalid")&&(e.classList.remove("fr-fieldset--error"),e.querySelector(".fr-error-text").classList.add("fr-hidden"))})),checkFirstStep(e)&&e.querySelector('[role="alert"]').classList.add("fr-hidden")}))):e.querySelectorAll('input,textarea,select,fieldset[aria-required="true"]').forEach((t=>{if("FIELDSET"===t.tagName)checkFieldset(e)||(t.addEventListener("change",(()=>{checkFieldset(e)})),invalid=t.parentElement);else if(!t.checkValidity()){let r=t.parentElement;"radio"===t.type&&(r=t.parentElement.parentElement.parentElement),[t.classList,r.classList].forEach((e=>{e.add(e[0]+"--error")})),r?.querySelector(".fr-error-text")?.classList.remove("fr-hidden"),t.addEventListener("input",(()=>{t.checkValidity()&&([t.classList,r.classList].forEach((e=>{e.remove(e[0]+"--error")})),r.querySelector(".fr-error-text")?.classList.add("fr-hidden"))})),invalid=e?.querySelector("*:invalid:first-of-type")?.parentElement}})),invalid){const e=invalid.getBoundingClientRect().top+window.scrollY;window.scroll({top:e,behavior:"smooth"})}}))})),document?.querySelectorAll('[name="bo-filter-form"]').forEach((e=>{e.addEventListener("change",(()=>{e.submit()}))})),document?.querySelectorAll("[data-fr-select-target]")?.forEach((e=>{let t=document?.querySelector("#"+e.getAttribute("data-fr-select-source")),r=document?.querySelector("#"+e.getAttribute("data-fr-select-target"));e.addEventListeners("click touchdown",(()=>{[...t.selectedOptions].map((e=>{let t,a=e.parentElement.getAttribute("data-select-group-id");r.querySelector('[data-select-group-id="'+a+'"]')?t=r.querySelector('[data-select-group-id="'+a+'"]'):(t=document.createElement("optgroup"),t.setAttribute("data-select-group-id",a),t.label=e.parentElement.label),t.append(e),r.append(t)}))}))})),document?.querySelector("#signalement-affectation-form-submit")?.addEventListeners("click touchdown",(e=>{e.preventDefault(),e.target.disabled=!0,e.target?.form?.querySelectorAll("option").forEach((e=>{e.selected=!0})),document?.querySelectorAll("#signalement-affectation-form-row,#signalement-affectation-loader-row").forEach((e=>{e.classList.toggle("fr-hidden")}));let t=new FormData(e.target.form);fetch(e.target.getAttribute("formaction"),{method:"POST",body:t}).then((e=>{e.ok&&window.location.reload(!0)}))})),document?.querySelectorAll(".fr-input--file-signalement").forEach((e=>{e.addEventListener("change",(e=>{e.target.form.submit()}))})),document?.querySelector("#partenaire_add_user,#situation_add_critere")?.addEventListeners("click touchdown",(e=>{let t,r,a,l,n;e.preventDefault(),"partenaire_add_user"===e.target.id?(t=document.importNode(document.querySelector("#partenaire_add_user_row").content,!0),r=document.querySelector("#partenaire_add_user_placeholder"),n="partenaire-row-user",a=r.querySelectorAll("."+n)?.length):(t=document.importNode(document.querySelector("#situation_add_critere_row").content,!0),r=document.querySelector("#situation_add_critere_placeholder"),n="situation-row-critere",a=r.querySelectorAll("."+n)?.length),l=document.createElement("div"),l.classList.add("fr-grid-row","fr-grid-row--gutters","fr-grid-row--middle","fr-background-alt--blue-france","fr-mb-5v",n),t.querySelectorAll("label,input,select,button,textarea").forEach((e=>{e.id=e?.id?.replaceAll("__ID__",a),e.name=e?.name?.replaceAll("__ID__",a),"LABEL"===e.tagName&&e.setAttribute("for",e.getAttribute("for").replaceAll("__ID__",a)),"BUTTON"===e.tagName&&e.addEventListeners("click touchdown",(e=>{e.target.closest("."+n).remove()}))})),l.appendChild(t),r.appendChild(l)})),document?.querySelectorAll("[data-delete]")?.forEach((e=>{e.addEventListeners("click touchdown",(t=>{let r;if(t.preventDefault(),t.target.classList.contains("partenaire-user-delete")?r=".partenaire-row-user":t.target.classList.contains("situation-critere-delete")?r=".situation-row-critere":t.target.classList.contains("signalement-file-delete")?r=".signalement-file-item":t.target.classList.contains("signalement-row-delete")?r=".signalement-row":t.target.classList.contains("partenaire-row-delete")&&(r=".partenaire-row"),confirm("Voulez-vous vraiment supprimer cet élément ?")){let t=new FormData;t.append("_token",e.getAttribute("data-token")),fetch(e.getAttribute("data-delete"),{method:"POST",body:t}).then((t=>{t.ok&&e.closest(r).remove()}))}}))})),document?.querySelector("#fr-bug-report-modal").addEventListeners("dsfr.disclose dsfr.conceal",(e=>{let t=e.target.querySelector('form[name="bug-report"]'),r=new FormData(t);"dsfr.disclose"===e.type?(e.target.querySelector("#bug-report-success").classList.add("fr-hidden"),t.classList.remove("fr-hidden"),e.target.querySelector("#bug-report-submit").disabled=!1,html2canvas(document.body).then((function(e){e.toBlob((e=>{r.append("capture",e,"capture.png")}))})),t.addEventListener("submit",(a=>{a.preventDefault(),a.stopPropagation(),e.target.querySelector("#bug-report-submit").disabled=!0,fetch(t.action,{method:"POST",body:r}).then((r=>r.text().then((()=>{t.classList.add("fr-hidden"),e.target.querySelector("#bug-report-success").classList.remove("fr-hidden")}))))}))):(r=null,e.target.querySelector("textarea").value="")})),document?.querySelectorAll(".fr-password-toggle")?.forEach((e=>{e.addEventListeners("click touchdown",(e=>{["fr-fi-eye-off-fill","fr-fi-eye-fill"].map((t=>{e.target.classList.toggle(t)}));let t=e.target.parentElement.querySelector('[name^="password"]');"text"!==t.type?t.type="text":t.type="password"}))})),document?.querySelector('form[name="login-creation-mdp-form"]')?.querySelectorAll('[name^="password"]').forEach((e=>{e.addEventListener("input",(()=>{let e=document?.querySelector('form[name="login-creation-mdp-form"] #login-password').value,t=document?.querySelector('form[name="login-creation-mdp-form"] #login-password-repeat').value,r=document?.querySelector('form[name="login-creation-mdp-form"] #password-match-error'),a=document?.querySelector('form[name="login-creation-mdp-form"] #submitter');e!==t?(document?.querySelector('form[name="login-creation-mdp-form"]').querySelectorAll(".fr-input-group").forEach((e=>{e.classList.add("fr-input-group--error"),e.querySelector(".fr-input").classList.add("fr-input--error")})),a.disabled=!0,r.classList.remove("fr-hidden")):(document?.querySelector('form[name="login-creation-mdp-form"]').querySelectorAll(".fr-input-group--error,.fr-input--error").forEach((e=>{["fr-input-group--error","fr-input--error"].map((t=>{e.classList.remove(t)}))})),r.classList.add("fr-hidden"),a.disabled=!1)}))})),document?.querySelectorAll(".fr-tabs__panel")?.forEach((e=>{e.addEventListener("dsfr.conceal",(()=>{"signalement-step-1-panel"===e.id&&e.querySelectorAll('[aria-expanded="true"]').forEach((e=>{localStorage.setItem(e.id,"true")}));const t=e.getBoundingClientRect().top+window.scrollY;window.scroll({top:t,behavior:"smooth"})}))})),document?.querySelector("#signalement-step-1-panel")?.addEventListener("dsfr.disclose",(e=>{e.target.querySelectorAll("[aria-expanded]").forEach((e=>{localStorage.getItem(e.id)&&(document.querySelector("#"+e.id).setAttribute("aria-expanded","true"),localStorage.removeItem(e.id))}))})),document?.querySelectorAll("[data-goto-step]")?.forEach((e=>{e.addEventListeners("click touchdown",(t=>{var r;t.preventDefault(),r=e.getAttribute("data-goto-step"),document.querySelector("#signalement-step-"+r).click()}))})),document?.querySelectorAll(".toggle-criticite-smiley").forEach((e=>{e.addEventListener("change",(e=>{let t=e.target.labels[0]?.parentElement?.querySelector(".fr-radio-rich__img img");e.target.parentElement.parentElement.querySelectorAll(".fr-radio-rich__img img").forEach((e=>{e.src=e.getAttribute("data-fr-unchecked-icon")})),!0===e.target.checked&&(t.src=e.target.parentElement.querySelector(".fr-radio-rich__img img").getAttribute("data-fr-checked-icon"))}))}));