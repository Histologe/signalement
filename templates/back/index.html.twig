{% extends 'back/base_bo.html.twig' %}

{% block content %}
    <section class="fr-col-12 fr-col-md fr-background-alt--blue-france fr-p-5v">
        <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--center">
            <div class="fr-col-3">
                <div class="fr-rounded fr-p-3v fr-text--center bloc-stat">
                    <span class="fr-display-xs">{{ signalements.counts.new }}</span><br>
                    <strong class="text-blue-france">Nouveaux</strong>
                </div>
            </div>
            <div class="fr-col-3">
                <div class="fr-rounded fr-p-3v fr-text--center bloc-stat">
                    <span class="fr-display-xs">{{ signalements.counts.await }}</span><br>
                    <strong class="text-blue-france">En attente</strong>
                </div>
            </div>
            <div class="fr-col-3">
                <div class="fr-rounded fr-p-3v fr-text--center bloc-stat">
                    <span class="fr-display-xs">{{ signalements.counts.review }}</span><br>
                    <strong class="text-blue-france">A revoir</strong>
                </div>
            </div>
            <div class="fr-col-3">
                <div class="fr-col fr-rounded fr-p-3v fr-text--center bloc-stat">
                    <span class="fr-display-xs">{{ signalements.counts.closed }}</span><br>
                    <strong class="text-blue-france">Fermés</strong>
                </div>
            </div>
        </div>
    </section>
    <section class="fr-col-12 fr-p-5v">
        <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--center">
            <form action="#" name="bo-filter-form" method="POST" class="fr-col-4">
                <label class="fr-label" for="filter_ville"><strong>Filter par ville</strong></label>
                <select name="bo-filter-ville" id="filter_ville" class="fr-select">
                    <option value="all">TOUTES</option>
                    {% for ville in signalements.villes %}
                        <option value="{{ ville }}"
                                {% if filter.ville is same as(ville) %}selected{% endif %}>{{ ville|upper }}</option>
                    {% endfor %}
                </select>
            </form>
            <form action="#" name="bo-filter-form" method="POST" class="fr-col-4">
                <label class="fr-label" for="filter_statut"><strong>Filter par statut</strong></label>
                <select name="bo-filter-statut" id="filter_statut" class="fr-select">
                    <option value="all">TOUS</option>
                    {% set statuts = {
                        'need-validation':'A valider',
                        'new':'Nouveaux',
                        'wait':'En attente d\'info.',
                        'review':'A revoir',
                        'closed':'Fermés',
                        'is-invalid':'Non-valide',
                    } %}
                    {% for statut,wording in statuts %}
                        <option value="{{ statut }}"
                                {% if filter.status is same as(statut) %}selected{% endif %}>{{ wording|upper }}</option>
                    {% endfor %}
                </select>
            </form>
            <form action="{{ path('back_index') }}" method="POST" class="fr-col-4">
                <label class="fr-label" for="header-search-input"><strong>Rechercher</strong></label>
                <div class="fr-search-bar fr-mt-2v" id="header-search">
                    <input class="fr-input" placeholder="Rechercher" type="search" id="header-search-input"
                           name="search" value="">
                    <button class="fr-btn" title="Rechercher">
                        Rechercher
                    </button>
                </div>
            </form>
            <div class="fr-col-12 fr-text--right fr-pt-0">
                <a href="{{ path('back_index') }}" class="fr-link fr-link--icon-left fr-fi-close-circle-line">Réinitialiser les résultats</a>
            </div>
        </div>

    </section>
    <section class="fr-col-12 fr-table fr-table--bordered">
        <table class="fr-display-inline-table">
            <thead class="fr-background-alt--blue-france">
            <tr>
                <th>#Ref.</th>
                <th>Date</th>
                {#<th>Situation(s)</th>#}
                {# <th>Alert.</th> #}
                {# <th>Criticité</th> #}
                <th>Criticité</th>
                <th>Occupant</th>
                <th>Adresse</th>
                <th>Affectation</th>
                <th>Etat</th>
                <th class="fr-text--right ">Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for index,signalement in signalements.list %}
                <tr class="{% if signalement.statut is same as("new") %}fr-background-contrast--orange-terre-battue{% endif %} signalement-row">
                    <td>
                        <a href="{{ path('back_signalement_view',{uuid:signalement.uuid}) }}">{{ signalement.reference }}</a>
                    </td>
                    <td>{{ signalement.createdAt|date('d/m/Y') }}</td>
                    <td>
                        <canvas id="gauge-signalement-{{ signalement.id }}" class="fr-col-4"></canvas>
                    </td>
                    <td>
                        {{ signalement.nomOccupant|upper~' '~signalement.prenomOccupant|capitalize }}
                    </td>
                    <td>{{ signalement.villeOccupant|upper }} <br>
                        <small>[{{ signalement.adresseOccupant }}]</small>
                    </td>
                    <td>
                        {% for affectation in signalement.affectationStatusByPartenaire %}
                            {% set classe = '' %}
                            {% if affectation.statut is same as (0) %}
                                {% set classe = 'fr-text--orange fr-fi-question-fill' %}
                            {% elseif affectation.statut is same as (1) %}
                                {% set classe = 'fr-text-label--green-emeraude fr-fi-checkbox-circle-fill' %}
                            {% elseif affectation.statut is same as (2) %}
                                {% set classe = 'fr-text-label--red-marianne fr-fi-close-circle-fill' %}
                            {% endif %}
                            <text class="{{ classe }} fr-display-block"><span class="fr-text--black"> {{ affectation.partenaire }}</span></text>
                        {% else %}
                            Aucune
                        {% endfor %}
                    </td>
                    <td>
                        {% if signalement.statut is same as('new') %}
                            Nouveau
                        {% elseif signalement.statut is same as('await') %}
                            En attente d'info. complémentaire
                        {% elseif signalement.statut is same as('review') %}
                            A revoir
                        {% elseif signalement.statut is same as('need-validation') %}
                            <strong class="fr-text-label--red-marianne">A valider</strong>
                        {% elseif signalement.statut is same as('is-invalid') %}
                            <strong class="fr-text-label--red-marianne">Non-valide</strong>
                        {% else %}
                            Fermé
                        {% endif %}
                    </td>
                    <td class="fr-text--right">
                            <a href="{{ path('back_signalement_view',{uuid:signalement.uuid}) }}" class="fr-btn fr-btn--sm fr-fi-eye-fill"></a>
                            <a href="{{ path('back_signalement_edit',{uuid:signalement.uuid}) }}" class="fr-btn fr-btn--secondary fr-btn--sm fr-fi-edit-fill"></a>
                            <button data-delete="{{ path('back_signalement_delete',{uuid:signalement.uuid}) }}" data-token="{{ csrf_token('signalement_delete_'~signalement.id) }}" class="fr-btn fr-btn--sm fr-btn--danger fr-fi-delete-fill signalement-row-delete"></button>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </section>
{% endblock %}
{% block javascripts %}
    <script>
        {% for signalement in signalements.list %}
        opts.pointer = {
            length: 0.49, // // Relative to gauge radius
            strokeWidth: 0.1, // The thickness
            color: '#000000' // Fill color
        }
        gauge = new Gauge(document.getElementById('gauge-signalement-{{ signalement.id }}')).setOptions(opts); // create sexy gauge!
        gauge.maxValue = 100; // set max gauge value
        gauge.setMinValue(0);  // Prefer setter over gauge.minValue = 0
        gauge.animationSpeed = 100; // set animation speed (32 is default value)
        gauge.set({{ signalement.scoreCreation }}); // set actual value
        {% endfor %}
    </script>
{% endblock %}