{% extends 'back/base_bo.html.twig' %}

{% set picto_yes = '<small class="fr-background-alt--blue-france fr-text-label--blue-france fr-rounded fr-p-1v fr-text--bold fr-fi-checkbox-circle-fill fr-link--icon-right fr-pr-3v">&nbsp;Oui</small>' %}
{% set picto_no = '<small class="fr-background-contrast--red-marianne fr-text-default--error fr-rounded fr-p-1v fr-text--bold fr-fi-close-circle-fill fr-link--icon-right fr-pr-3v">&nbsp;Non</small>' %}

{% block content %}
    <section class="fr-p-5v">
        <header>
            <div class="fr-grid-row fr-grid-row--middle">
                <div class="fr-col-12 fr-col-md-6">
                    <h1 class="fr-h2 fr-mb-3v">Signalement #{{ signalement.reference }}</h1>
                    {% if signalement.isNotOccupant %}
                        <small class="fr-background-contrast--red-marianne fr-text-default--error fr-rounded fr-p-1v fr-text--bold fr-fi-information-fill fr-link--icon-right fr-pr-3v">&nbsp;
                            Signalement par un tiers</small>
                    {% else %}
                        <small class="fr-background-alt--blue-france fr-text-label--blue-france fr-rounded fr-p-1v fr-text--bold fr-fi-information-fill fr-link--icon-right fr-pr-3v">&nbsp;
                            Signalement par l'occupant</small>
                    {% endif %}
                    <text><strong>Déposé le:</strong> {{ signalement.createdAt|date('d/m/Y à H:i') }}</text>
                </div>
                <div class="fr-col-12 fr-col-md-6 fr-text--right">
                    {% if isAffected and not isAccepted and not isRefused %}
                        <form action="{{ path('back_signalement_affectation_response',{id:signalement.id,user:app.user.id}) }}">
                            <button class="fr-btn fr-fi-checkbox-circle-fill fr-btn--icon-left"
                                    name="signalement-affectation-response[accept]" value="1"
                                    onclick="return confirm('Êtes-vous certain de vouloir acccepter ce signalement ?')">
                                Je m'en
                                occupe
                            </button>
                            <button class="fr-btn fr-btn--danger fr-fi-close-circle-fill fr-btn--icon-left"
                                    name="signalement-affectation-response[deny]" value="1"
                                    onclick="return confirm('Êtes-vous certain de vouloir refuser ce signalement ?')">Ce
                                n'est pas
                                pour
                                moi
                            </button>
                            <input type="hidden" name="_token"
                                   value="{{ csrf_token('signalement_affectation_response') }}">
                        </form>
                        <span class="fr-hint-text fr-fi-calendar-line fr-tag--icon-right"><strong>&nbsp;&nbsp;Vous à été attribué le :</strong> {{ isAffected.createdAt|date('d/m/Y') }}</span>
                    {% elseif isAccepted %}
                        <strong class="fr-text-label--green-emeraude fr-fi-checkbox-circle-fill"> Vous avez
                            <u>accepté</u> ce
                            signalement</strong>
                        <span class="fr-hint-text fr-fi-calendar-line fr-tag--icon-right"><strong>&nbsp;&nbsp;Le :</strong> {{ isAccepted.answeredAt|date('d/m/Y') }}</span>
                    {% elseif isRefused %}
                        <strong class="fr-text-label--red-marianne fr-fi-checkbox-circle-fill"> Vous avez
                            <u>refusé</u>
                            ce
                            signalement</strong>
                        <span class="fr-hint-text fr-fi-calendar-line fr-tag--icon-right"><strong>&nbsp;&nbsp;Le :</strong> {{ isRefused.answeredAt|date('d/m/Y') }}</span>
                    {% endif %}
                </div>
            </div>
        </header>
        <hr>
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <strong class="fr-fi-chat-quote-fill fr-text-label--blue-france"> Description par l'usager</strong>
                <span class="fr-hint-text">Ci-dessous le détails du signalement tel que rapporté par l'usager</span>
                <ul class="fr-background-alt--blue-france fr-list--icon-img fr-rounded">
                    <li class="fr-p-5v">
                        {{ signalement.details }}
                    </li>
                </ul>
            </div>
        </div>
        <hr>
        {# {{ dump(signalement) }} #}
        <div class="fr-grid-row">
            <div class="fr-col-12 fr-col-md-6">
                {% if signalement.isNotOccupant %}
                    <strong class="fr-fi-information-fill fr-text-label--blue-france"> Informations du
                        déclarant</strong>
                    <span class="fr-hint-text">Ce signalement à été effectué par un tiers, les informations du déclarant sont les suivantes.</span>
                    <ul class="fr-list--icon-img">
                        <li><strong>Nom: </strong> {{ signalement.nomDeclarant }} -
                            <strong>Prénom: </strong> {{ signalement.prenomDeclarant }}</li>
                        <li><strong>Courriel: </strong><a
                                    href="mailto:{{ signalement.mailDeclarant }}">{{ signalement.mailDeclarant }}</a>
                        </li>
                        <li><strong>Téléphone: </strong>{{ signalement.telDeclarant }}</li>
                        <li><strong>Structure: </strong> {{ signalement.structureDeclarant }}</li>
                    </ul>
                {% endif %}
                <strong class="fr-fi-information-fill fr-text-label--blue-france"> Informations de l'occupant</strong>
                <span class="fr-hint-text">Ce signalement à été effectué par l'occupant du logement, les informations fournies sont les suivantes.</span>
                <ul class="fr-list--icon-img">
                    <li><strong>Nom: </strong> {{ signalement.nomOccupant }} -
                        <strong>Prénom: </strong> {{ signalement.prenomOccupant }}</li>
                    <li><strong>Courriel: </strong><a
                                href="mailto:{{ signalement.mailOccupant }}">{{ signalement.mailOccupant }}</a></li>
                    <li><strong>Téléphone: </strong><a
                                href="tel:{{ signalement.telOccupant }}">{{ signalement.telOccupant }}</a></li>
                    <li>
                        <strong>Adresse: </strong> {{ signalement.adresseOccupant ~', '~signalement.cpOccupant ~' '~ signalement.villeOccupant|upper }}
                    </li>
                    <li><strong>Occupant(s): </strong> {{ signalement.nbAdultes }}
                        <strong>Adulte(s)</strong>{% if signalement.nbEnfantsM6 %} - {{ signalement.nbEnfantsM6 }} Enfant(s)
                        <u><strong>moins</strong></u> 6 ans{% endif %}{% if signalement.nbEnfantsP6 %} - {{ signalement.nbEnfantsP6 }} Enfant(s)
                            <u><strong>plus</strong></u> 6 ans{% endif %}</li>
                    <li><strong>Date
                            d'entrée: </strong> {{ signalement.dateEntree ? signalement.dateEntree|date('d/m/Y') : 'N/R' }}
                    </li>
                    <li>
                        <strong>Logement: </strong> {{ signalement.typeLogement }} de {{ signalement.superficie }}m² -
                        <strong>Loyer: </strong> {{ signalement.loyer }} €/mois
                    </li>
                    <li>
                        <strong>Allocataire: </strong>
                        {% if signalement.isAllocataire %}
                            {{ picto_yes|raw }}
                        {% else %}
                            {{ picto_no|raw }}
                        {% endif %}
                    </li>
                    {% if signalement.isAllocataire %}
                        <li>
                            <strong>N° allocataire: </strong> {{ signalement.numAllocataire }}
                        </li>
                        <li>
                            <strong>Montant allocation: </strong> {{ signalement.montantAllocation ?? 'N/R' }} €/mois
                        </li>
                    {% endif %}
                    <li>
                        <strong>Situation de handicap: </strong>
                        {% if signalement.isSituationHandicap %}
                            {{ picto_yes|raw }}
                        {% else %}
                            {{ picto_no|raw }}
                        {% endif %}

                    </li>
                    <li>
                        <div class="fr-responsive-img fr-grid-row fr-grid-row--gutters fr-p-4v">
                            <div id="map-signalement-view" class="fr-rounded fr-mt-5v fr-col-12"
                                 style="height: 300px;"></div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="fr-col-12 fr-col-md-6">
                <strong class="fr-fi-alert-fill fr-text-label--blue-france"> Criticité du signalement</strong>
                <span class="fr-hint-text">La criticité est calculée automatiquement en fonction des situations signalées.</span>
                <ul class="fr-list--icon-img">
                    <li>
                        <div class="fr-responsive-img fr-grid-row">
                            <img src="https://via.placeholder.com/500x75.png?text=Slider+criticite" alt="Maps"
                                 class="fr-col-12 fr-rounded fr-mt-5v">
                        </div>
                    </li>
                </ul>
                <strong class="fr-fi-eye-fill fr-text-label--blue-france"> Constatation du signalement</strong>
                <span class="fr-hint-text">Le signalement doit être constaté afin d'optimiser le temps de traitement</span>
                <ul class="fr-list--icon-img">
                    <li>
                        <strong>Accord pour visite: </strong>
                        {% if signalement.isRefusIntervention %}
                            {{ picto_no|raw }}
                            <span class="fr-hint-text"><u><strong>Motif:</strong></u> {{ signalement.raisonRefusIntervention }}</span>
                        {% else %}
                            {{ picto_yes|raw }}
                        {% endif %}
                    </li>
                    {% if not signalement.isRefusIntervention %}
                        <li>
                            <strong>Visite effectuée: </strong>
                            {% if signalement.dateVisite %}
                                {{ picto_yes|raw }}
                            {% else %}
                                {{ picto_no|raw }}
                            {% endif %}
                        </li>
                        {% if signalement.dateVisite %}
                            <li>
                                <strong>Date de visite: </strong> {{ signalement.dateVisite|date('d/m/Y') }}
                            </li>
                            <li>
                                <strong>Occupant présent: </strong>
                                {% if signalement.isOccupantPresentVisite %}
                                    {{ picto_yes|raw }}
                                {% else %}
                                    {{ picto_no|raw }}
                                {% endif %}
                            </li>
                        {% endif %}
                    {% endif %}
                </ul>
                <strong class="fr-fi-alert-fill fr-text-label--blue-france"> Ce signalement concerne les points
                    suivants:</strong>
                <span class="fr-hint-text">Récapitulatif des situations rencontrées par l'occupant du logement</span>
                <ul class="fr-list--icon-img">
                    {% for situation in signalement.jsonContent %}
                        <li class="fr-background-alt--blue-france fr-mb-5v fr-p-5v fr-rounded">
                            <strong>{{ situation.label|capitalize }}</strong>
                            <ul>
                                {% for critere in situation.critere %}
                                    <li><strong>{{ critere.label|capitalize }}</strong>
                                        <ul class="fr-list fr-skiplinks__list fr-list--icon-img">
                                            {% for criticite in critere.criticite %}
                                                <li>- {{ criticite.label|capitalize }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <hr>
        <div class="fr-grid-row">
            <div class="fr-col-12 fr-col-md-6">
                <strong class="fr-fi-information-fill fr-text-label--blue-france"> Informations du propriétaire</strong>
                <span class="fr-hint-text">Ci-dessous les informations concernant le proprétaire ou gestionnaire bailleur du logement.</span>
                <ul class="fr-list--icon-img">
                    <li>
                        <strong>Propriétaire averti: </strong>
                        {% if signalement.isProprioAverti %}
                            {{ picto_yes|raw }}
                        {% else %}
                            {{ picto_no|raw }}
                        {% endif %}
                    </li>
                    <li><strong>Nom: </strong> {{ signalement.nomProprio ?? 'N/R' }}
                    <li><strong>Courriel: </strong><a
                                href="mailto:{{ signalement.mailProprio }}">{{ signalement.mailProprio ?? 'N/R' }}</a>
                    </li>
                    <li><strong>Téléphone: </strong><a
                                href="tel:{{ signalement.telProprio }}">{{ signalement.telProprio ?? 'N/R' }}</a></li>
                    <li><strong>Adresse: </strong> {{ signalement.adresseProprio ?? 'N/R' }}</li>
                </ul>
            </div>
            <div class="fr-col-12 fr-col-md-6">
                <strong class="fr-fi-information-fill fr-text-label--blue-france"> Informations du logement</strong>
                <span class="fr-hint-text">Ci-dessous les informations concernant le logement et autres info concernant le bail.</span>
                <ul class="fr-list--icon-img">
                    <li>
                        <strong>Bail en cours: </strong>
                        {% if signalement.isBailEnCours %}
                            {{ picto_yes|raw }}
                        {% else %}
                            {{ picto_no|raw }}
                        {% endif %}
                    </li>
                    <li>
                        <strong>Logement social: </strong>
                        {% if signalement.isLogementSocial %}
                            {{ picto_yes|raw }}
                        {% else %}
                            {{ picto_no|raw }}
                        {% endif %}
                    </li>
                    <li>
                        <strong>Demande de relogement: </strong>
                        {% if signalement.isRelogement %}
                            {{ picto_yes|raw }}
                        {% else %}
                            {{ picto_no|raw }}
                        {% endif %}
                    </li>
                    <li>
                        <strong>Preavis de départ: </strong>
                        {% if signalement.isPreavisDepart %}
                            {{ picto_yes|raw }}
                        {% else %}
                            {{ picto_no|raw }}
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
        <hr>
        <div class="fr-grid-row fr-grid-row--middle">
            <div class="fr-col-12 fr-col-md-6">
                <strong class="fr-fi-upload-2-fill fr-text-label--blue-france"> Photos et documents</strong>
                <span class="fr-hint-text">Ci-dessous les informations concernant le proprétaire ou gestionnaire bailleur du logement.</span>
            </div>
            <div class="fr-col-12 fr-col-md-6 fr-text--right">
                <button class="fr-btn fr-fi-file-fill fr-btn--icon-left"> Ajouter un/des document(s)</button>
                <button class="fr-btn fr-btn--danger fr-fi-instagram-fill fr-btn--icon-left"> Ajouter un/des photo(s)
                </button>
            </div>
        </div>
        <div class="fr-grid-row fr-grid-row--middle fr-grid-row--gutters fr-mt-3v">
            {% for photo in signalement.photos %}
                <div role="button" class="fr-col-6 fr-col-md-2 fr-rounded" title="Cliquez pour voir la photo">
                    <div class="fr-px-5w fr-py-10w fr-rounded"
                         style="background: url('{{ asset('_up/'~photo) }}')no-repeat center center/cover"></div>
                </div>
            {% endfor %}
            {% for document in signalement.documents %}
                <div role="button" class="fr-col-6 fr-col-md-2 fr-rounded" title="Cliquez pour voir le document">
                    <div class="fr-px-5w fr-py-10w fr-rounded"
                         style="background: url('{{ asset('img/document.png') }}')no-repeat center center/contain"></div>
                </div>
            {% endfor %}
        </div>
        <hr class="fr-mt-5v">
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <strong class="fr-fi-refresh-fill fr-text-label--blue-france"> Retour d'affectation</strong>
                <span class="fr-hint-text">Ci-dessous le ou les retour(s) d'affectation connu(s)</span>
            </div>
        </div>
        <div class="fr-grid-row fr-py-5v fr-grid-row--gutters">
            {% for affectation in signalement.affectations %}
                {% if affectation.statut is same as(0) %}
                    {# STATUT EN ATTENTE #}
                    <div class="fr-col-md-2">
                        <div class="fr-background-contrast--info fr-rounded fr-p-2v">
                            <small>[{{ affectation.user.partenaire ? affectation.user.partenaire.nom : 'AUCUN' }}] <br>
                                <strong class="fr-fi-refresh-line fr-tag--icon-right">&nbsp;&nbsp;{{ affectation.user.nom[:1]|upper~'. '~affectation.user.prenom|capitalize }}</strong>
                                en attente.</small>
                            <span class="fr-hint-text fr-fi-calendar-line fr-tag--icon-right"><strong>&nbsp;&nbsp;Affecté le :</strong> {{ affectation.createdAt|date('d/m/Y') }}</span>
                        </div>
                    </div>
                {% elseif affectation.statut is same as(1) %}
                    {# STATUT ACCEPTE #}
                    <div class="fr-col-md-2">
                        <div class="fr-background-contrast--success fr-rounded fr-p-2v">
                            <small>[{{ affectation.user.partenaire ? affectation.user.partenaire.nom : 'AUCUN' }}]
                                <br>
                                <strong class="fr-fi-checkbox-circle-line fr-tag--icon-right">&nbsp;&nbsp;{{ affectation.user.nom[:1]|upper~'. '~affectation.user.prenom|capitalize }}</strong>
                                à
                                accepté.</small>
                            <span class="fr-hint-text fr-fi-calendar-line fr-tag--icon-right"><strong>&nbsp;&nbsp;Le :</strong> {{ affectation.answeredAt|date('d/m/Y') }}</span>

                        </div>
                    </div>
                {% elseif affectation.statut is same as(2) %}
                    {# STATUT REFUSE #}
                    <div class="fr-col-md-2">
                        <div class="fr-background-contrast--error fr-rounded fr-p-2v">
                            <small>[{{ affectation.user.partenaire ? affectation.user.partenaire.nom : 'AUCUN' }}] <br>
                                <strong class="fr-fi-close-circle-line fr-tag--icon-right">&nbsp;&nbsp;{{ affectation.user.nom[:1]|upper~'. '~affectation.user.prenom|capitalize }}</strong>
                                à refusé.</small>
                            <span class="fr-hint-text fr-fi-calendar-line fr-tag--icon-right"><strong>&nbsp;&nbsp;Le :</strong> {{ affectation.answeredAt|date('d/m/Y') }}</span>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% if is_granted('ROLE_ADMIN_PARTENAIRE') and signalement.statut != "closed" %}
            <div class="fr-grid-row">
                <div class="fr-col-12">
                    <strong class="fr-fi-user-fill fr-text-label--blue-france"> Affectation(s)</strong>
                    <span class="fr-hint-text">Ci-dessous la ou les affection(s) du signalement. Vous pouvez en ajouter/supprimer en selectionnant le partenaire.</span>
                </div>
            </div>

            <div class="fr-grid-row fr-grid-row--gutters fr-py-5v">
                {% for partenaire in partenaires %}
                    <div class="fr-col-2">
                        <div class="fr-background-alt--blue-france fr-p-5v fr-rounded">
                            <strong>{{ partenaire.nom }}</strong> <br>
                            <ul class="fr-list--icon-img fr-list--hover ">
                                {% for user in partenaire.users %}
                                    <li class="fr-checkbox-affectation__parent {% for u in signalement.affectations|filter(v => v.user is same as(user)) %}fr-fi-checkbox-circle-fill fr-text-label--green-emeraude{% else %}fr-fi-close-circle-fill fr-text-label--red-marianne{% endfor %}">
                                        <label for="signalement-affectation-{{ user.id }}"
                                               class="fr-text--sm">{{ user.nom[:1]|upper~'. '~user.prenom|capitalize }}
                                            {# {% for affectation in signalement.affectations %}{% if user is same as (affectation.user) %}<span class="fr-hint-text fr-fi-calendar-line fr-tag--icon-right">&nbsp; {{ affectation.createdAt|date('d/m/Y') }}</small></span>{% endif %}{% endfor %} #}
                                            <input type="checkbox" class="fr-checkbox-affectation fr-hidden"
                                                   id="signalement-affectation-{{ user.id }}"
                                                   {% for u in signalement.affectations|filter(v => v.user is same as(user)) %}checked{% endfor %}
                                                   data-toggle-fetch="{{ path('back_signalement_toggle_affectation',{id:signalement.id,user:user.id}) }}">
                                        </label>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        <hr>
        <div class="fr-grid-row">
            <div class="fr-col-12">
                <strong class="fr-fi-calendar-fill fr-text-label--blue-france"> Suivis du signalement</strong>
                <span class="fr-hint-text">Ci-dessous l'historique des changements d'états et interventions du signalement.</span>
                <strong>Nouveau suivi:</strong>
                <form method="POST"
                      action="{{ path('back_signalement_add_suivi',{id:signalement.id}) }}"{# class="needs-validation" #}
                      name="signalement-add-suivi" novalidate>
                    <div class="fr-input-group">
                        <label class="fr-label" for="signalement-add-suivi-content">
                            <span class="fr-hint-text"> Décrivez la ou les action(s) menée(s)<sup
                                        class="fr-text-default--error">*</sup></span>
                        </label>
                        <textarea class="fr-input fr-input--no-resize" id="signalement-add-suivi-content"
                                  name="signalement-add-suivi[content]" required></textarea>
                        <p class="fr-error-text fr-hidden">
                            Merci de proposer une rapide description (minimum 10 caractères).
                        </p>
                    </div>
                    <button type="submit" class="fr-btn fr-fi-eye-off-fill fr-btn--icon-left"
                            name="signalement-add-suivi[isPublic]" value="0"> Enregistrer (privé)
                    </button>
                    <button type="submit" class="fr-btn fr-btn--secondary fr-fi-eye-fill fr-btn--icon-left"
                            name="signalement-add-suivi[isPublic]" value="1"> Enregistrer (visible par usager)
                    </button>
                    <input type="hidden" name="_token" value="{{ csrf_token('signalement_add_suivi') }}">
                </form>
            </div>
        </div>
        <hr>
        {% for suivi in signalement.suivis %}
            <div class="fr-grid-row fr-grid-row--middle fr-stripped fr-rounded fr-p-2v">
                <div class="fr-col-2">
                    <strong> {{ suivi.createdBy.nom[:1]|upper~'. '~ suivi.createdBy.prenom|capitalize }}</strong> <br>
                    <small>{{ suivi.createdAt|date('d/m/Y') }}</small>
                </div>
                <div class="fr-col-9">
                    {{ suivi.description|capitalize }}
                </div>
                <div class="fr-col-1 fr-text--right">
                    {% if suivi.isPublic %}
                        <span class="fr-fi-eye-fill" title="Visible par l'usage"></span>
                    {% else %}
                        <span class="fr-fi-eye-off-fill" title="Non visible par l'usager"></span>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </section>
{% endblock %}
{% block javascripts %}
    <script>
        let map = L.map('map-signalement-view').setView([{{ signalement.geoloc.lng }}, {{ signalement.geoloc.lat }}], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

        L.marker([{{ signalement.geoloc.lng }}, {{ signalement.geoloc.lat }}]).addTo(map)
            .bindPopup('{{ signalement.adresseOccupant~', '~signalement.cpOccupant~' '~signalement.villeOccupant|upper }}')
            .openPopup();
    </script>
{% endblock %}