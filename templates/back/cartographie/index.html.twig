{% extends 'back/base_bo.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
{#    <section class="fr-grid-row fr-grid-row--middle fr-p-5v ">
        <div class="fr-col-6">
            <h1 class="fr-h2 fr-mb-0">GÃ©olocalisation des signalements</h1>
        </div>
    </section>#}
    <section class="fr-grid-row fr-pt-0 fr-h-100">
        <div class="fr-col-12 fr-p-5v">
            <div class="fr-rounded fr-h-100 fr-w-100" id="map-signalements-view"></div>
        </div>
    </section>
{% endblock %}
{% block javascripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>
        let map = L.map('map-signalements-view').setView([{{ signalements|last.geoloc.lng }}, {{ signalements|last.geoloc.lat }}], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);
        var regions = L.geoJSON(null, {
            pointToLayer: function (pointFeature, latlng) {
                return L.circleMarker(latlng, {
                    radius:6,
                    opacity: .8
                })
                    .bindPopup("<p><b> " + pointFeature.properties.EPCI + "</b></p>");
            }
        });
        fetch('{{ asset('test.geojson') }}',{
            method:'GET',
        }).then(r=>r.json().then(res=>{
            res.features.map((feature,index)=>{
                regions.addData(feature)
            })
            regions.addTo(map);
            map.fitBounds(regions.getBounds());
        }))
        let markers = L.markerClusterGroup();
        {% for signalement in signalements %}
        {% if signalement.geoloc.lat is defined and signalement.geoloc.lng is defined %}
        markers.addLayer(L.marker([{{ signalement.geoloc.lng }}, {{ signalement.geoloc.lat }}]).bindPopup('<a href="{{ path('back_signalement_view',{uuid:signalement.uuid}) }}">#{{ signalement.reference }}</a>'))
        {% endif %}
        {% endfor %}
        map.addLayer(markers);
    </script>
{% endblock %}
